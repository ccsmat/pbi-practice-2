Level: Advanced

Please read https://github.com/ccsmat/pbi-practice-1 first. This is an extended practice.

# Goal: Allow the user to select the ProductNumber in the Power BI report.

In the previous practice, the filter for ProductNumber was set in Power Query. The goal in this practice is to let the user freely select the ProductNumber as a filter condition when viewing the report.

If the model is designed for this scenario, there won't be a problem. However, as mentioned in the previous practice, the model has complex relationships. This goal cannot be achieved by simply dragging fields onto the canvas.

# Attempt 1: Create a parameter in Power Query and use bind to parameter to pass the user selection to the parameter for refreshing the table.

Result: Failed. ETL with direct query is restricted.

Dynamic M query parameters only work with direct query (DQ). However, the merge actions in Power Query are not supported in DQ. We need to do the data transformation in another place.

refs: https://learn.microsoft.com/en-us/power-bi/connect-data/desktop-dynamic-m-query-parameters

# Data transforamtion: build a table having columns of LastName, FirstName, BusinessEntityID and ProductNumber

We need a person-ProductNumber mapping table so the report user can select the ProductNumber in Power BI as a filter.

```sql
SELECT t2.*
	,t1.ProductNumber
FROM (
	SELECT ssh.SalesPersonID
		,sub1.*
	FROM Sales.SalesOrderHeader ssh
	INNER JOIN (
		SELECT pp.ProductNumber
			,pp.Name
			,pp.ProductID
			,ss.SalesOrderID
		FROM Sales.SalesOrderDetail ss
		INNER JOIN Production.Product pp ON ss.ProductID = pp.ProductID
			-- WHERE pp.ProductNumber = 'BK-M68B-42'
		) sub1 ON ssh.SalesOrderID = sub1.SalesOrderID
	WHERE ssh.SalesPersonID IS NOT NULL
	) t1
INNER JOIN (
	SELECT ppn.LastName
		,ppn.FirstName
		,e.BusinessEntityID
	FROM Person.Person ppn
	INNER JOIN HumanResources.Employee e ON e.BusinessEntityID = ppn.BusinessEntityID
	) t2 ON t1.SalesPersonID = t2.BusinessEntityID
```

![image](https://github.com/ccsmat/pbi-practice-2/assets/29472739/1b9099ba-a327-4b57-9007-9dcb8b648fc4)

# Attempt 2: Use SQL query in datamart to do the data transformation.

Result: Faild.

The query works properly in the editor but an error occurs when exploring the data. Since there is no way to save this exploration, we cannot go further.

```sql
SELECT t2.*, t1.ProductNumber
FROM (
	SELECT ssh.SalesPersonID
		,sub1.*
	FROM [Sales SalesOrderHeader] ssh
	INNER JOIN (
		SELECT pp.ProductNumber
			,pp.Name
			,pp.ProductID
			,ss.SalesOrderID
		FROM [Sales SalesOrderDetail] ss
		INNER JOIN [Production Product] pp ON ss.ProductID = pp.ProductID
		WHERE pp.ProductNumber = 'BK-M68B-42'
		) sub1 ON ssh.SalesOrderID = sub1.SalesOrderID
	WHERE ssh.SalesPersonID IS NOT NULL
	) t1
INNER JOIN (
	SELECT ppn.LastName
		,ppn.FirstName
		,e.BusinessEntityID
	FROM [Person Person] ppn
	INNER JOIN [HumanResources Employee] e ON e.BusinessEntityID = ppn.BusinessEntityID
	) t2 ON t1.SalesPersonID = t2.BusinessEntityID
```

![image](https://github.com/ccsmat/pbi-practice-2/assets/29472739/37bf1f89-cca5-49e9-b43d-55977b949230)
![image](https://github.com/ccsmat/pbi-practice-2/assets/29472739/8d4c9c59-8b15-412a-a390-fde19a114404)

# Attempt 3: Use visual query in datamart to do the data transformation.

Result: Failed.

The visual query uses Power Query as the editor. The expected table can be achieved. However, an error shows when visualizing the results. We cannot go further if we cannot save this result as a model.

![image](https://github.com/ccsmat/pbi-practice-2/assets/29472739/8f71f8b6-f265-46e9-bcf9-93be7fed4cf1)

![image](https://github.com/ccsmat/pbi-practice-2/assets/29472739/7d55cc4c-c90f-4daa-9a22-eec2b82ce445)

# Attempt 4: Create a view in SQL DB.

Result: Successful.

![pbipractice2](https://github.com/ccsmat/pbi-practice-2/assets/29472739/0c9e8844-2d32-43d8-a482-46b14a876f1a)

Steps:
1. Create a view of the result table generated by the query above
2. Load the view in Power BI as a direct query table
3. Duplicate the DQ table and get a list with distinct ProductNumber
4. Create a parameter and use it to filter the DQ table
5. Bind the ProductNumber filed in the ProductNumber table to the parameter

**Do not create relationship between these tables**

![image](https://github.com/ccsmat/pbi-practice-2/assets/29472739/b6c6162d-416e-4402-bac3-203abddddb44)

![image](https://github.com/ccsmat/pbi-practice-2/assets/29472739/8156ba7b-e33d-454e-8aa8-9f4342080943)
